<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Magic Tiles Clone</title>
  <style>
    body {
      margin: 0;
      background: #111;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    canvas {
      display: block;
      margin: auto;
      background: #222;
    }
    #feedback {
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      color: #fff;
      text-shadow: 2px 2px 5px black;
      opacity: 0;
      transition: opacity 0.3s ease-out;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="400" height="600"></canvas>
  <div id="feedback"></div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const laneWidth = canvas.width / 4;
    const speed = 3;
    let tiles = [];
    let score = 0;
    let keysPressed = {};

    // Charger la musique
    const audio = new Audio("musique.mp3");
    audio.loop = false;

    document.body.addEventListener("click", () => {
      audio.play().catch(() => {});
    }, { once: true });

    // Classe Tile (bloc normal ou long)
    class Tile {
      constructor(lane, y, type = "normal", length = 1) {
        this.lane = lane;
        this.y = y;
        this.type = type; // "normal" ou "long"
        this.length = length; // longueur (en nombre de cases)
        this.hit = false;
        this.held = false;
      }

      draw() {
        ctx.fillStyle = this.type === "long" ? "#0f0" : "#09f";
        let tileHeight = 100 * this.length;
        ctx.fillRect(this.lane * laneWidth, this.y, laneWidth - 4, tileHeight - 4);
      }

      update() {
        this.y += speed;
      }
    }

    // Feedback visuel
    function showFeedback(text) {
      const fb = document.getElementById("feedback");
      fb.innerText = text;
      fb.style.opacity = 1;
      setTimeout(() => fb.style.opacity = 0, 500);
    }

    // Génération aléatoire des blocs
    function spawnTile() {
      const lane = Math.floor(Math.random() * 4);
      const type = Math.random() < 0.3 ? "long" : "normal"; // 30% de chance long
      const length = type === "long" ? 2 + Math.floor(Math.random() * 2) : 1;
      tiles.push(new Tile(lane, -100 * length, type, length));
    }

    // Vérification appui
    function checkHit(lane) {
      for (let tile of tiles) {
        if (!tile.hit &&
            tile.lane === lane &&
            tile.y + 100 * tile.length > canvas.height - 120 &&
            tile.y < canvas.height - 20) {

          if (tile.type === "normal") {
            tile.hit = true;
            score++;
            showFeedback("Perfect!");
          } else if (tile.type === "long") {
            if (keysPressed[lane]) {
              tile.held = true;
              score += 2;
              showFeedback("Hold!");
            }
          }
        }
      }
    }

    // Relâcher après bloc long
    function releaseLane(lane) {
      for (let tile of tiles) {
        if (tile.held && tile.lane === lane) {
          tile.hit = true;
          tile.held = false;
          score += 3;
          showFeedback("Great!");
        }
      }
    }

    // Contrôles clavier
    window.addEventListener("keydown", e => {
      if (["ArrowLeft", "ArrowDown", "ArrowUp", "ArrowRight"].includes(e.key)) {
        const lane = { ArrowLeft: 0, ArrowDown: 1, ArrowUp: 2, ArrowRight: 3 }[e.key];
        keysPressed[lane] = true;
        checkHit(lane);
      }
    });

    window.addEventListener("keyup", e => {
      if (["ArrowLeft", "ArrowDown", "ArrowUp", "ArrowRight"].includes(e.key)) {
        const lane = { ArrowLeft: 0, ArrowDown: 1, ArrowUp: 2, ArrowRight: 3 }[e.key];
        keysPressed[lane] = false;
        releaseLane(lane);
      }
    });

    // Boucle principale
    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (Math.random() < 0.02) spawnTile();

      for (let tile of tiles) {
        tile.update();
        tile.draw();
      }

      tiles = tiles.filter(tile => tile.y < canvas.height + 200);

      ctx.fillStyle = "#fff";
      ctx.font = "20px Arial";
      ctx.fillText("Score: " + score, 10, 30);

      requestAnimationFrame(gameLoop);
    }

    gameLoop();
  </script>
</body>
</html>
