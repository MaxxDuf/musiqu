<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mini Magic Tiles</title>
  <style>
    body { margin:0; background:#111; overflow:hidden; font-family:Arial,sans-serif; color:white; text-align:center; }
    canvas { display:block; margin:20px auto; background:#222; border:2px solid #555; cursor:pointer; }
    #hud { margin:10px; }
    #progressContainer { width:80%; margin:10px auto; height:20px; background:#333; border-radius:10px; overflow:hidden; }
    #progressBar { height:100%; width:0%; background:linear-gradient(90deg,gold,orange); }
    #stars { margin:5px; font-size:24px; color:gold; }
    #startBtn { padding:10px 20px; font-size:20px; margin-top:20px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>🎵 Mini Magic Tiles</h1>
  <button id="startBtn">Commencer</button>
  <div id="hud" style="display:none;">
    Score: <span id="score">0</span> | Vies: <span id="lives">3</span>
    <div id="progressContainer"><div id="progressBar"></div></div>
    <div id="stars"></div>
  </div>
  <canvas id="gameCanvas" width="400" height="600"></canvas>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startBtn = document.getElementById("startBtn");
    const hud = document.getElementById("hud");
    const scoreSpan = document.getElementById("score");
    const livesSpan = document.getElementById("lives");
    const progressBar = document.getElementById("progressBar");
    const starsDiv = document.getElementById("stars");

    let tiles = [];
    let score = 0;
    let lives = 3;
    let baseSpeed = 2;
    let speed = baseSpeed;
    let running = false;
    let stars = 0;
    let spawnChance = 0.01;

    const songDuration = 204;
    const audio = new Audio("musique.mp3");

    class Tile {
      constructor(lane) {
        this.lane = lane;
        this.y = -120;
        this.w = canvas.width / 4;
        this.h = 120;
        this.hit = false;
      }
      update() { this.y += speed; }
      draw() {
        ctx.fillStyle = this.hit ? "#444" : "#09f";
        ctx.fillRect(this.lane * this.w, this.y, this.w - 4, this.h - 4);
      }
      contains(x,y){
        return !this.hit &&
               x >= this.lane * this.w && x <= (this.lane+1)*this.w &&
               y >= this.y && y <= this.y + this.h;
      }
    }

    startBtn.onclick = () => {
      startBtn.style.display = "none";
      hud.style.display = "block";
      audio.currentTime = 0;
      audio.play();
      resetGame();
      running = true;
      gameLoop();
    };

    function resetGame(){
      tiles = [];
      score = 0;
      lives = 3;
      speed = baseSpeed;
      stars = 0;
      scoreSpan.textContent = score;
      livesSpan.textContent = lives;
      starsDiv.textContent = "";
    }

    function canSpawn(lane) {
      return !tiles.some(t => t.lane === lane && t.y < 150);
    }

    function spawnTile(){
      let lane;
      let attempts = 0;
      do {
        lane = Math.floor(Math.random() * 4);
        attempts++;
      } while (!canSpawn(lane) && attempts < 10);

      if(Math.random() < spawnChance){
        tiles.push(new Tile(lane));
      }
    }

    // Clic souris
    canvas.addEventListener("click", e => {
      if(!running) return;
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;

      let hitAny = false;
      for(let tile of tiles){
        if(tile.contains(mx,my)){
          tile.hit = true;
          score += 10;
          scoreSpan.textContent = score;
          hitAny = true;
          break;
        }
      }
      if(!hitAny) loseLife();
    });

    function loseLife(){
      lives--;
      livesSpan.textContent = lives;
      if(lives <= 0){ running = false; audio.pause(); alert("Game Over ! Score: "+score); }
    }

    function updateProgress(){
      const percent = Math.min((audio.currentTime / songDuration) * 100, 100);
      progressBar.style.width = percent+"%";

      let newStars = Math.floor(percent/20);
      if(newStars > stars){
        stars = newStars;
        starsDiv.textContent = "⭐".repeat(stars);
      }

      speed = baseSpeed + (percent/20);
      spawnChance = 0.01 + (percent/200);

      if(percent >= 100){ running = false; audio.pause(); alert("Victoire 🎉 Score: "+score); }
    }

    function gameLoop(){
      if(!running) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      spawnTile();

      tiles.forEach(tile=>{ tile.update(); tile.draw(); });

      tiles = tiles.filter(tile=>{
        if(tile.y > canvas.height){
          if(!tile.hit){ loseLife(); }
          return false;
        }
        return true;
      });

      updateProgress();
      requestAnimationFrame(gameLoop);
    }
  </script>
</body>
</html>
