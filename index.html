<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Magic Tiles Clone</title>
  <style>
    body {
      margin: 0;
      background: #111;
      overflow: hidden;
      font-family: Arial, sans-serif;
      color: #fff;
    }
    canvas {
      display: none;
      margin: auto;
      background: #222;
    }
    #feedback {
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      text-shadow: 2px 2px 5px black;
      opacity: 0;
      transition: opacity 0.3s ease-out;
    }
    #progressContainer {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 20px;
      background: #333;
      border-radius: 10px;
      overflow: hidden;
      display: none;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, gold, orange);
      border-radius: 10px;
      transition: width 0.2s;
    }
    #stars {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 28px;
      color: gold;
      display: none;
    }
    #menu {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    #startBtn {
      font-size: 24px;
      padding: 12px 24px;
      background: #0f0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #endScreen {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    #restartBtn {
      margin-top: 20px;
      font-size: 20px;
      padding: 10px 20px;
      background: #09f;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="400" height="600"></canvas>
  <div id="feedback"></div>
  <div id="progressContainer"><div id="progressBar"></div></div>
  <div id="stars"></div>

  <!-- Menu de démarrage -->
  <div id="menu">
    <h1>🎵 Magic Tiles Clone 🎵</h1>
    <button id="startBtn">Commencer</button>
  </div>

  <!-- Écran de fin -->
  <div id="endScreen">
    <h1 id="endMessage"></h1>
    <button id="restartBtn">Rejouer</button>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const laneWidth = canvas.width / 4;
    let speed = 3;
    let tiles = [];
    let score = 0;
    let keysPressed = {};

    const songDuration = 204; // 3:24
    const audio = new Audio("musique.mp3");
    audio.loop = false;

    const progressBar = document.getElementById("progressBar");
    const starsDiv = document.getElementById("stars");
    const feedback = document.getElementById("feedback");
    const menu = document.getElementById("menu");
    const startBtn = document.getElementById("startBtn");
    const endScreen = document.getElementById("endScreen");
    const endMessage = document.getElementById("endMessage");
    const restartBtn = document.getElementById("restartBtn");

    let stars = 0;
    let running = false;

    class Tile {
      constructor(lane, y, type = "normal", length = 1) {
        this.lane = lane;
        this.y = y;
        this.type = type;
        this.length = length;
        this.hit = false;
        this.held = false;
      }
      draw() {
        ctx.fillStyle = this.type === "long" ? "#0f0" : "#09f";
        let tileHeight = 100 * this.length;
        ctx.fillRect(this.lane * laneWidth, this.y, laneWidth - 4, tileHeight - 4);
      }
      update() { this.y += speed; }
    }

    function showFeedback(text) {
      feedback.innerText = text;
      feedback.style.opacity = 1;
      setTimeout(() => feedback.style.opacity = 0, 500);
    }

    function spawnTile() {
      const lane = Math.floor(Math.random() * 4);
      const type = Math.random() < 0.3 ? "long" : "normal";
      const length = type === "long" ? 2 + Math.floor(Math.random() * 2) : 1;
      tiles.push(new Tile(lane, -100 * length, type, length));
    }

    function checkHit(lane) {
      for (let tile of tiles) {
        if (!tile.hit &&
            tile.lane === lane &&
            tile.y + 100 * tile.length > canvas.height - 120 &&
            tile.y < canvas.height - 20) {

          if (tile.type === "normal") {
            tile.hit = true;
            score++;
            showFeedback("Perfect!");
          } else if (tile.type === "long") {
            if (keysPressed[lane]) {
              tile.held = true;
              score += 2;
              showFeedback("Hold!");
            }
          }
        }
      }
    }

    function releaseLane(lane) {
      for (let tile of tiles) {
        if (tile.held && tile.lane === lane) {
          tile.hit = true;
          tile.held = false;
          score += 3;
          showFeedback("Great!");
        }
      }
    }

    window.addEventListener("keydown", e => {
      if (["ArrowLeft","ArrowDown","ArrowUp","ArrowRight"].includes(e.key)) {
        const lane = {ArrowLeft:0,ArrowDown:1,ArrowUp:2,ArrowRight:3}[e.key];
        keysPressed[lane] = true;
        checkHit(lane);
      }
    });
    window.addEventListener("keyup", e => {
      if (["ArrowLeft","ArrowDown","ArrowUp","ArrowRight"].includes(e.key)) {
        const lane = {ArrowLeft:0,ArrowDown:1,ArrowUp:2,ArrowRight:3}[e.key];
        keysPressed[lane] = false;
        releaseLane(lane);
      }
    });

    function updateProgress() {
      const currentTime = audio.currentTime;
      const percent = Math.min((currentTime / songDuration) * 100, 100);
      progressBar.style.width = percent + "%";

      const newStars = Math.floor(percent / 25);
      if (newStars > stars) {
        stars = newStars;
        starsDiv.innerText = "⭐".repeat(stars);
        speed += 1;
      }

      if (currentTime >= songDuration) {
        endGame();
      }
    }

    function gameLoop() {
      if (!running) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (Math.random() < 0.02) spawnTile();

      for (let tile of tiles) {
        tile.update();
        tile.draw();
      }

      tiles = tiles.filter(tile => tile.y < canvas.height + 200);

      ctx.fillStyle = "#fff";
      ctx.font = "20px Arial";
      ctx.fillText("Score: " + score, 10, 30);

      updateProgress();
      requestAnimationFrame(gameLoop);
    }

    function startGame() {
      menu.style.display = "none";
      canvas.style.display = "block";
      document.getElementById("progressContainer").style.display = "block";
      starsDiv.style.display = "block";
      tiles = [];
      score = 0;
      stars = 0;
      speed = 3;
      running = true;
      audio.currentTime = 0;
      audio.play();
      gameLoop();
    }

    function endGame() {
      running = false;
      canvas.style.display = "none";
      document.getElementById("progressContainer").style.display = "none";
      starsDiv.style.display = "none";
      endMessage.innerText = `Partie terminée 🎵 Score: ${score}`;
      endScreen.style.display = "block";
    }

    startBtn.addEventListener("click", startGame);
    restartBtn.addEventListener("click", () => {
      endScreen.style.display = "none";
      startGame();
    });
  </script>
</body>
</html>
